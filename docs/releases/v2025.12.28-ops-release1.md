# Release v2025.12.28-ops-release1

**Tag:** v2025.12.28-ops-release1
**Date:** 2025-12-28
**Branch:** ops/ngrok-systemd-fix-20251228

## Summary
This release contains operational fixes and documentation updates validated on host N1 (armbian). Key items:

- Fixes for DOCX report generation parity and compatibility (tests): removed a trailing empty paragraph and added an xpath compatibility shim for docx/lxml combinations. ✅
- ngrok operational improvements: added a robust wrapper (`/usr/local/bin/calb-ngrok-wrapper`), systemd drop-in updates to use the wrapper, and safer StartLimit/Restart handling. ✅
- Health checks: improved `/opt/calb/tools/calb_health_check.py` to probe both ngrok local APIs (4040/4041) and report health to `/opt/calb/health/calb-health.json`. ✅
- Docs: added `docs/N1_DEPLOYMENT_RUNBOOK.md` updates including explicit ngrok troubleshooting (ERR_NGROK_313/334/6030) and a non-interactive prod deploy flow. ✅
- Tests: Ran full test suite on test venv — **22 passed, 2 skipped**. ✅

## Notable files changed
- calb_sizing_tool/reporting/export_docx.py — strip trailing paragraph and xpath shim
- calb_sizing_tool/__init__.py — compatibility helper (monkeypatch for xpath)
- /usr/local/bin/calb-ngrok-wrapper (deployed on host) — robust startup wrapper
- deploy/systemd/calb-ngrok@.service.d/override.conf — systemd drop-in using wrapper
- /opt/calb/tools/calb_health_check.py — probe both 4040 and 4041 and emit `/opt/calb/health/calb-health.json`
- docs/N1_DEPLOYMENT_RUNBOOK.md — ngrok troubleshooting & deploy steps
- tools/deploy.sh — non-interactive deploy helper

## Operational notes
- The ngrok account on N1 is on the **Free** plan: custom `subdomain:` values are not permitted (ERR_NGROK_313). To have distinct reserved public URLs for `prod` and `test`, upgrade to a paid ngrok plan or use a single public endpoint with a local reverse proxy.
- `calb-ngrok@test` was left inactive because the prod tunnel owns the free public endpoint (ERR_NGROK_334). See runbook for recovery options.
- Health file: `/opt/calb/health/calb-health.json` is now updated and reports status OK when both streamlit and ngrok are reachable.

## How to roll back
- On prod: `cd /opt/calb/prod/CALB_SIZINGTOOL && git checkout <previous-tag> && ./tools/deploy.sh prod`

## Validation performed
- Unit tests: `pytest` (22 passed, 2 skipped)
- Smoke: curl checks to `http://127.0.0.1:8511` and the public ngrok URL (returned 200)
- Service checks: `systemctl status calb-sizingtool@prod` and `calb-ngrok@prod` show active

---

*This release note was created automatically by the on-host ops process.*
