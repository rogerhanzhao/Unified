â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CALB ESS SIZING TOOL - REPAIR PROPOSAL SUMMARY
  Date: 2025-12-31
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CURRENT STATE: Three critical issues in diagram & report generation.
PRINCIPLE: Fix DISPLAY LAYER ONLY. Do NOT modify sizing calculations.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ISSUE #1: SLD (Single Line Diagram) - DC Circuit Appears Coupled
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FILE: calb_diagrams/sld_pro_renderer.py (Lines ~470â€“580)

PROBLEM:
  âœ— PCS-1 and PCS-2 DC circuits visually appear parallel/coupled
  âœ— Viewers don't see clear separation between independent MPPT regions
  âœ— Code claims independence but rendering suggests false coupling

FIX:
  âœ“ Insert 50-100px visual gap between PCS-1 DC region and PCS-2 DC region
  âœ“ Add zone labels: "PCS-1 Independent DC Circuit" / "PCS-2 Independent DC Circuit"
  âœ“ Ensure horizontal DC BUSBAR lines are LOCAL to each PCS (not spanning entire width)
  âœ“ Add allocation labels: "DC Blocks [1-2] â†’ PCS-1 (independent)"

VALIDATION: Render multi-PCS SLD â†’ verify clear spatial gap & independence.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ISSUE #2: Layout (Top View) - DC Block Internal Arrangement Wrong
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FILE: calb_diagrams/layout_block_renderer.py (Lines ~115â€“150, ~260â€“300)

PROBLEM:
  âœ— DC Block shows 2Ã—3 grid (2 columns, 3 rows) of battery modules
  âœ— Actual CALB 5MWh container has 1Ã—6 arrangement (6 vertical racks)
  âœ— Unwanted small rectangle on left side of DC Block
  âœ— Interior text labels ("Cooling", "Battery") clutter design

FIX:
  âœ“ Change module grid: cols=2, rows=3  â†’  cols=6, rows=1 (1Ã—6 single row)
  âœ“ Delete code drawing unwanted left-side small rectangle
  âœ“ Remove interior text labels (keep only container ID + capacity on outside)
  âœ“ Validate final output: 6 module rectangles + container border + external labels

VALIDATION: Generate Layout SVG â†’ inspect each DC Block (should show 6 bars in a row, no left box).

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ISSUE #3: DOCX Report Export - Data Inconsistency & Verbosity
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FILE: calb_sizing_tool/reporting/report_v2.py (Lines ~216â€“650)

SUB-ISSUE 3A: Efficiency Chain Math Doesn't Check Out
  PROBLEM:
    âœ— Total Efficiency â‰  product of components
    âœ— Reader sees: Total=96.74% but components multiply to 94.5% â†’ credibility lost
  FIX:
    âœ“ Read component efficiencies from DC Sizing (single source of truth)
    âœ“ Calculate Total = DC_Cables Ã— PCS Ã— Transformer Ã— RMU Ã— HVT
    âœ“ Validate: if |Total_provided - Total_calculated| > 0.1% â†’ use calculated value
    âœ“ Add disclaimer: "Efficiency figures exclude auxiliary systems (HVAC, lighting, etc.)"

SUB-ISSUE 3B: AC Sizing Table - Repeats 23 Identical Rows
  PROBLEM:
    âœ— If all 23 AC Blocks have same config, table has 23 identical rows
    âœ— Unprofessional, hard to read, defeats summary purpose
  FIX:
    âœ“ Aggregate by config signature (PCS rating, count, transformer, etc.)
    âœ“ Output only unique configs with "Block Count" column
    âœ“ Example: Instead of 23 rows of "2 Ã— 2500kW = 5.0MW"
               Output 1 row: "23 blocks | 2 Ã— 2500kW = 5.0MW"

SUB-ISSUE 3C: Missing PCS Rating & Custom Input
  PROBLEM:
    âœ— PCS options: 1250, 1500, 1725, 2500 kW (missing 2000 kW)
    âœ— No custom input for edge cases
  FIX:
    âœ“ Add PCS_RATING_OPTIONS = [1250, 1500, 1725, 2000, 2500]
    âœ“ Add UI checkbox + number input: "Custom Rating?" â†’ allows user-defined kW

VALIDATION:
  âœ“ Export DOCX â†’ check Efficiency total matches component product Â±0.1%
  âœ“ Check AC table: no repeated rows, shows counts
  âœ“ Check for auxiliary disclaimer
  âœ“ Verify 2000 kW available in AC sizing UI

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IMPLEMENTATION ORDER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. SLD Rendering Fixes (sld_pro_renderer.py)
   â””â”€ Add visual gap & labels between PCS DC regions
   
2. Layout Rendering Fixes (layout_block_renderer.py)
   â””â”€ Change 2Ã—3 â†’ 1Ã—6, remove left box, clean interior
   
3. Report Export Fixes (report_v2.py)
   â”œâ”€ Fix efficiency chain math + add disclaimer
   â”œâ”€ Aggregate AC table (remove repeats)
   â””â”€ Validate consistency
   
4. UI Config Updates (ac_sizing_config.py or similar)
   â””â”€ Add 2000 kW option + custom input field
   
5. Testing & Validation
   â””â”€ Unit tests + manual smoke tests

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ACCEPTANCE CRITERIA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ“ SLD: Clear spatial gap between PCS-1 and PCS-2 DC regions (NO visual coupling)
âœ“ SLD: Each PCS has labeled independent DC BUSBAR A/B
âœ“ Layout: DC Blocks show 1Ã—6 module grid (6 bars in one row)
âœ“ Layout: No unwanted small rectangle on left; no interior text clutter
âœ“ Report: Efficiency Total = product(components) within 0.1%
âœ“ Report: "Auxiliary excluded" disclaimer present
âœ“ Report: AC Sizing table de-duplicated (one row per unique config + count)
âœ“ Report: 2000 kW PCS option available + custom input enabled
âœ“ REGRESSION: All sizing calculations unchanged, same results as before

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
KEY PRINCIPLE (REMINDER)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸš« DO NOT TOUCH:
   - Sizing logic (DC/AC blocks, power allocation, PCS counts)
   - Efficiency calculations (only fix DISPLAY/CONSISTENCY)
   - File names, export locations, DOCX format, chapter structure

âœ… ALLOWED TO TOUCH:
   - SVG/diagram rendering (display layer)
   - DOCX content generation (aggregation, formatting, tables)
   - UI config (add PCS options, custom input)
   - Report text & disclaimers

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
For detailed analysis, see: REPAIR_PROPOSAL.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
